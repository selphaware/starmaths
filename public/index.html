<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>â­ Star Maths â€” Space Adventure!</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --deep:#0a0e27;--mid:#141937;--light:#1e2650;
  --purple:#7c3aed;--pink:#ec4899;--blue:#3b82f6;
  --gold:#fbbf24;--orange:#f97316;--cyan:#22d3ee;--green:#34d399;
  --red:#ef4444;--moon:#f0f0ff;--ring:#c084fc;
  --ff:'Fredoka',sans-serif;--fm:'Space Mono',monospace;
}
html,body{height:100%;font-family:var(--ff);background:var(--deep);color:var(--moon);overflow-x:hidden}

/* â”€â”€ Starfield â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
body::before,body::after{content:'';position:fixed;inset:0;pointer-events:none;z-index:0}
body::before{
  background:
    radial-gradient(1.5px 1.5px at 10% 20%,#fff 50%,transparent 100%),
    radial-gradient(1px 1px at 30% 60%,#dde 50%,transparent 100%),
    radial-gradient(2px 2px at 50% 10%,var(--gold) 50%,transparent 100%),
    radial-gradient(1px 1px at 70% 80%,#fff 50%,transparent 100%),
    radial-gradient(1.5px 1.5px at 90% 40%,#ccf 50%,transparent 100%),
    radial-gradient(1px 1px at 15% 90%,#fff 50%,transparent 100%),
    radial-gradient(2px 2px at 85% 15%,var(--cyan) 50%,transparent 100%),
    radial-gradient(1px 1px at 45% 45%,#fff 50%,transparent 100%),
    radial-gradient(1.5px 1.5px at 60% 70%,#eef 50%,transparent 100%),
    radial-gradient(1px 1px at 25% 35%,#fff 50%,transparent 100%);
  animation:twinkle 4s ease-in-out infinite alternate;
}
body::after{
  background:
    radial-gradient(1px 1px at 5% 50%,#fff 50%,transparent 100%),
    radial-gradient(1.5px 1.5px at 20% 10%,#eef 50%,transparent 100%),
    radial-gradient(1px 1px at 40% 85%,#fff 50%,transparent 100%),
    radial-gradient(2px 2px at 65% 30%,var(--gold) 50%,transparent 100%),
    radial-gradient(1px 1px at 80% 65%,#fff 50%,transparent 100%),
    radial-gradient(1.5px 1.5px at 95% 90%,#ddf 50%,transparent 100%);
  animation:twinkle 5s ease-in-out 1s infinite alternate;opacity:.7;
}
@keyframes twinkle{0%{opacity:.6}100%{opacity:1}}

.nebula{position:fixed;border-radius:50%;filter:blur(80px);opacity:.15;pointer-events:none;z-index:0}
.n1{width:500px;height:500px;background:var(--purple);top:-100px;right:-100px}
.n2{width:400px;height:400px;background:var(--pink);bottom:-50px;left:-50px}
.n3{width:350px;height:350px;background:var(--blue);top:50%;left:50%;transform:translate(-50%,-50%)}

.planet{position:fixed;border-radius:50%;pointer-events:none;z-index:0}
.p1{width:60px;height:60px;bottom:10%;right:5%;background:radial-gradient(circle at 35% 35%,var(--orange),#c2410c);box-shadow:inset -8px -8px 15px rgba(0,0,0,.4),0 0 20px rgba(249,115,22,.3);animation:ob1 20s linear infinite}
.p2{width:40px;height:40px;top:15%;left:8%;background:radial-gradient(circle at 35% 35%,var(--cyan),#0891b2);box-shadow:inset -5px -5px 10px rgba(0,0,0,.4),0 0 15px rgba(34,211,238,.3);animation:ob2 15s linear infinite}
.p3{width:80px;height:80px;top:60%;left:3%;background:radial-gradient(circle at 30% 30%,#c084fc,#7c3aed);box-shadow:inset -10px -10px 20px rgba(0,0,0,.3),0 0 25px rgba(192,132,252,.2);animation:ob3 25s linear infinite}
.p3::after{content:'';position:absolute;top:50%;left:50%;width:120px;height:20px;border-radius:50%;border:3px solid rgba(192,132,252,.4);transform:translate(-50%,-50%) rotate(-20deg)}
@keyframes ob1{0%{transform:translateY(0)}50%{transform:translateY(-15px) translateX(8px)}100%{transform:translateY(0)}}
@keyframes ob2{0%{transform:translateY(0)}50%{transform:translateY(10px) translateX(-10px)}100%{transform:translateY(0)}}
@keyframes ob3{0%{transform:translateY(0) rotate(0deg)}50%{transform:translateY(-15px) rotate(5deg)}100%{transform:translateY(0) rotate(0deg)}}

/* â”€â”€ Screens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.screen{display:none;position:relative;z-index:1;min-height:100vh;padding:20px}
.screen.active{display:flex;flex-direction:column;align-items:center}

/* â”€â”€ Shared â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.title{
  font-size:clamp(2rem,6vw,3.8rem);font-weight:700;text-align:center;line-height:1.2;
  background:linear-gradient(135deg,var(--gold),var(--orange),var(--pink),var(--purple));
  background-size:300% 300%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;
  background-clip:text;animation:shimmer 4s ease-in-out infinite;
}
@keyframes shimmer{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}
.subtitle{font-size:1.05rem;opacity:.7;text-align:center}
.rocket-float{font-size:3.5rem;text-align:center;animation:float 3s ease-in-out infinite}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}

.btn-primary{
  background:linear-gradient(135deg,var(--purple),var(--blue));border:none;border-radius:16px;
  padding:14px 32px;color:#fff;font-family:var(--ff);font-size:1rem;font-weight:700;cursor:pointer;transition:.2s;
}
.btn-primary:hover{transform:scale(1.05);box-shadow:0 4px 20px rgba(124,58,237,.5)}
.btn-secondary{
  background:transparent;border:2px solid rgba(255,255,255,.15);border-radius:16px;
  padding:14px 32px;color:var(--moon);font-family:var(--ff);font-size:1rem;font-weight:600;cursor:pointer;transition:.2s;
}
.btn-secondary:hover{border-color:var(--cyan)}
.btn-row{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}

/* â”€â”€ Character Select â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#char-screen{justify-content:center;gap:20px;padding:30px 20px}
.char-grid{
  display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));
  gap:10px;max-width:850px;width:100%;
}
.char-btn{
  background:var(--light);border:2px solid rgba(255,255,255,.06);
  border-radius:16px;padding:10px 4px 8px;text-align:center;cursor:pointer;
  transition:.25s;display:flex;flex-direction:column;align-items:center;gap:2px;
}
.char-btn:hover{transform:translateY(-3px);border-color:var(--gold);box-shadow:0 6px 20px rgba(251,191,36,.25)}
.char-btn.selected{border-color:var(--cyan);background:rgba(34,211,238,.12);box-shadow:0 0 20px rgba(34,211,238,.3)}
.char-emoji{font-size:2rem;line-height:1.1}
.char-name{font-size:.65rem;font-weight:600;opacity:.8;line-height:1.1}
.btn-go{margin-top:10px;font-size:1.15rem;padding:16px 50px}

/* â”€â”€ Level Select â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#level-screen{gap:20px;padding-top:20px}
.level-header{display:flex;align-items:center;gap:12px;margin-bottom:4px}
.level-header .avatar{font-size:2.2rem}
.level-header h2{font-size:1.3rem;font-weight:700}
.level-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;max-width:900px;width:100%}
.level-card{
  background:linear-gradient(145deg,var(--light),var(--mid));border:2px solid rgba(255,255,255,.06);
  border-radius:20px;padding:20px;cursor:pointer;transition:.3s;position:relative;overflow:hidden;
}
.level-card::before{content:'';position:absolute;inset:0;border-radius:20px;background:linear-gradient(135deg,transparent 60%,rgba(124,58,237,.12));pointer-events:none}
.level-card:hover{transform:translateY(-4px);border-color:var(--cyan);box-shadow:0 8px 30px rgba(34,211,238,.2)}
.lv-num{font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--cyan);margin-bottom:2px}
.lv-name{font-size:1.15rem;font-weight:700;margin-bottom:6px}
.lv-ops{font-size:.85rem;opacity:.7}
.lv-meta{font-size:.72rem;opacity:.45;margin-top:4px}
.lv-mult{display:inline-block;background:rgba(251,191,36,.15);color:var(--gold);font-size:.7rem;font-weight:700;padding:2px 8px;border-radius:8px;margin-top:6px}

/* â”€â”€ Game Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#game-screen{justify-content:center;gap:18px}
.game-hud{display:flex;justify-content:space-between;align-items:center;width:100%;max-width:620px;gap:8px;flex-wrap:wrap}
.hud-item{background:var(--light);border-radius:14px;padding:8px 14px;font-size:.85rem;font-weight:600;display:flex;align-items:center;gap:5px;border:1px solid rgba(255,255,255,.06)}
.timer-wrap{width:100%;max-width:620px;height:10px;background:var(--light);border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,.06)}
.timer-bar{height:100%;border-radius:10px;background:linear-gradient(90deg,var(--green),var(--cyan));transition:width .1s linear,background .5s}
.timer-bar.warn{background:linear-gradient(90deg,var(--orange),var(--red))}
.q-card{
  background:linear-gradient(145deg,var(--light),rgba(30,38,80,.8));
  border:2px solid rgba(255,255,255,.08);border-radius:24px;padding:36px 28px;
  text-align:center;width:100%;max-width:620px;min-height:200px;
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;position:relative;
}
.q-card::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 30% 30%,rgba(124,58,237,.08),transparent 60%);pointer-events:none}
.q-text{font-size:clamp(1.8rem,5vw,3rem);font-weight:700;line-height:1.4;position:relative}
.q-text .frac{display:inline-flex;flex-direction:column;align-items:center;vertical-align:middle;margin:0 6px;font-size:.7em;line-height:1}
.q-text .frac .num{border-bottom:3px solid var(--moon);padding:0 6px 4px}
.q-text .frac .den{padding:4px 6px 0}
.ans-row{display:flex;gap:12px;align-items:center}
.ans-input{
  background:var(--mid);border:2px solid rgba(255,255,255,.15);border-radius:16px;
  padding:14px 20px;font-family:var(--fm);font-size:1.5rem;color:var(--moon);
  text-align:center;width:200px;outline:none;transition:.2s;
}
.ans-input:focus{border-color:var(--cyan)}
.ans-input.correct{border-color:var(--green)!important;box-shadow:0 0 20px rgba(52,211,153,.4);animation:pop .3s ease}
.ans-input.wrong{border-color:var(--red)!important;box-shadow:0 0 20px rgba(239,68,68,.4);animation:shake .4s ease}
@keyframes pop{0%{transform:scale(1)}50%{transform:scale(1.08)}100%{transform:scale(1)}}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-8px)}75%{transform:translateX(8px)}}
.btn-go-q{background:linear-gradient(135deg,var(--purple),var(--blue));border:none;border-radius:16px;padding:14px 28px;color:#fff;font-family:var(--ff);font-size:1.1rem;font-weight:700;cursor:pointer;transition:.2s}
.btn-go-q:hover{transform:scale(1.05)}
.feedback{font-size:1rem;font-weight:600;min-height:1.4em}
.feedback.ok{color:var(--green)}.feedback.no{color:var(--red)}
.streak-line{font-size:.95rem;font-weight:600;color:var(--gold);min-height:1.4em}

/* â”€â”€ Results Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#results-screen{justify-content:center;gap:20px;padding:20px}
.results-card{
  background:linear-gradient(145deg,var(--light),var(--mid));border:2px solid rgba(255,255,255,.08);
  border-radius:28px;padding:36px 28px;text-align:center;width:100%;max-width:540px;
}
.res-emoji{font-size:4rem;margin-bottom:8px}
.res-title{font-size:1.8rem;font-weight:700;margin-bottom:4px}
.res-sub{font-size:.95rem;opacity:.7;margin-bottom:20px}

.score-hero{
  font-size:3rem;font-weight:700;margin:10px 0 4px;
  background:linear-gradient(135deg,var(--gold),var(--orange));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
}
.score-label{font-size:.8rem;opacity:.5;margin-bottom:16px;text-transform:uppercase;letter-spacing:1px}

.res-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:20px}
.rs{background:rgba(255,255,255,.04);border-radius:14px;padding:12px 8px}
.rs .v{font-size:1.4rem;font-weight:700}
.rs .l{font-size:.68rem;opacity:.5;margin-top:2px}
.rs .v.gold{color:var(--gold)}.rs .v.green{color:var(--green)}.rs .v.cyan{color:var(--cyan)}.rs .v.pink{color:var(--pink)}.rs .v.orange{color:var(--orange)}

.score-breakdown{text-align:left;margin:16px 0;font-size:.8rem;opacity:.7}
.score-breakdown h4{font-size:.75rem;text-transform:uppercase;letter-spacing:1px;opacity:.5;margin-bottom:6px}
.sb-row{display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid rgba(255,255,255,.04)}
.sb-row.perfect{color:var(--gold);font-weight:700}

.lb-section{margin-top:16px;text-align:left}
.lb-section h4{font-size:.75rem;text-transform:uppercase;letter-spacing:1px;opacity:.5;margin-bottom:8px;text-align:center}
.lb-row{display:flex;align-items:center;gap:8px;padding:5px 0;border-bottom:1px solid rgba(255,255,255,.04);font-size:.8rem}
.lb-rank{width:24px;text-align:center;font-weight:700;opacity:.6}
.lb-rank.top1{color:var(--gold);opacity:1}.lb-rank.top2{color:#c0c0c0;opacity:1}.lb-rank.top3{color:#cd7f32;opacity:1}
.lb-emoji{font-size:1.1rem}
.lb-name{flex:1;font-weight:600}
.lb-score{font-weight:700;color:var(--gold)}
.lb-you{background:rgba(34,211,238,.08);border-radius:8px;padding:5px 6px;margin:-1px -6px}

.perfect-banner{
  background:linear-gradient(135deg,var(--gold),var(--orange));color:var(--deep);
  border-radius:14px;padding:12px;font-weight:700;font-size:1rem;margin-bottom:10px;animation:pop .5s ease;
}

/* â”€â”€ Confetti â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.confetti-box{position:fixed;inset:0;pointer-events:none;z-index:100;overflow:hidden}
.confetti-piece{position:absolute;width:10px;height:10px;top:-10px;animation:cfall 3s ease-in forwards}
@keyframes cfall{0%{transform:translateY(0) rotate(0deg);opacity:1}100%{transform:translateY(110vh) rotate(720deg);opacity:0}}

/* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media(max-width:600px){
  .char-grid{grid-template-columns:repeat(auto-fill,minmax(72px,1fr));gap:8px}
  .char-emoji{font-size:1.5rem}.char-name{font-size:.55rem}
  .level-grid{grid-template-columns:1fr}
  .q-card{padding:20px 14px}
  .ans-input{width:140px;font-size:1.2rem}
  .results-card{padding:20px 14px}
  .res-stats{grid-template-columns:1fr 1fr 1fr;gap:6px}
}
.fade-in{animation:fadeIn .4s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
/* â”€â”€ Dedication footer (animated spectrum) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
body{ padding-bottom:44px; } /* stops footer covering content */

.dedication{
  position:fixed;
  left:0; right:0; bottom:0;
  z-index:2;
  display:flex;
  justify-content:center;
  align-items:center;
  padding:10px 12px;
  text-align:center;
  font: 600 12.5px/1.2 var(--ff);
  letter-spacing:.25px;
  opacity:.75;
  pointer-events:none; /* subtle; doesnâ€™t block clicks */
  background: linear-gradient(to top, rgba(10,14,39,.55), rgba(10,14,39,0));
}

.dedication .dedicationText{
  display:inline-block !important;

  background-image: linear-gradient(90deg,
    #ff4d4d 0%,
    #ffb84d 14%,
    #fff44d 28%,
    #4dff88 42%,
    #4dd2ff 57%,
    #6a5cff 71%,
    #ff4df3 85%,
    #ff4d4d 100%
  ) !important;

  background-size: 500% 100% !important;
  background-position: 0% 50% !important;

  -webkit-background-clip:text !important;
  background-clip:text !important;

  color: transparent !important;
  -webkit-text-fill-color: transparent !important;

  animation: dedicationSpectrum 10s linear infinite !important;
  will-change: background-position;
}

@keyframes dedicationSpectrum{
  0%   { background-position: 0% 50%; }
  100% { background-position: 500% 50%; }
}

@media (prefers-reduced-motion: reduce){
  .dedication .dedicationText{ animation:none !important; }
}
</style>
</head>
<body>
<div class="nebula n1"></div><div class="nebula n2"></div><div class="nebula n3"></div>
<div class="planet p1"></div><div class="planet p2"></div><div class="planet p3"></div>

<!-- â•â•â• CHARACTER SELECT â•â•â• -->
<div id="char-screen" class="screen active">
  <div class="rocket-float">ğŸš€</div>
  <h1 class="title">Star Maths</h1>
  <p class="subtitle">Pick your space explorer!</p>
  <div class="char-grid" id="char-grid"></div>
  <button class="btn-primary btn-go" id="btn-char-go" disabled onclick="confirmCharacter()">Choose Your Explorer! ğŸš€</button>
</div>

<!-- â•â•â• LEVEL SELECT â•â•â• -->
<div id="level-screen" class="screen">
  <div class="level-header">
    <span class="avatar" id="lv-avatar"></span>
    <h2 id="lv-greeting"></h2>
  </div>
  <p class="subtitle" style="margin-bottom:10px">Pick any mission â€” they're all open!</p>
  <div class="level-grid" id="level-grid"></div>
  <div style="margin-top:16px">
    <button class="btn-secondary" onclick="showScreen('char-screen')">â† Change Explorer</button>
  </div>
</div>

<!-- â•â•â• GAME â•â•â• -->
<div id="game-screen" class="screen">
  <div class="game-hud">
    <div class="hud-item"><span id="hud-char-emoji"></span> <span id="hud-level-name"></span></div>
    <div class="hud-item">â“ <span id="hud-qnum">1</span>/<span id="hud-qtotal">10</span></div>
    <div class="hud-item">âœ… <span id="hud-correct">0</span></div>
    <div class="hud-item">â± <span id="hud-timer">30</span>s</div>
  </div>
  <div class="timer-wrap"><div class="timer-bar" id="timer-bar"></div></div>
  <div class="q-card">
    <div class="q-text" id="q-text">Loading...</div>
    <div class="ans-row">
      <input type="text" class="ans-input" id="ans-input" placeholder="?" autocomplete="off" inputmode="text">
      <button class="btn-go-q" id="btn-submit" onclick="submitAnswer()">Go! ğŸš€</button>
    </div>
    <div class="feedback" id="feedback"></div>
    <div class="streak-line" id="streak-line"></div>
  </div>
</div>

<!-- â•â•â• RESULTS â•â•â• -->
<div id="results-screen" class="screen">
  <div class="results-card fade-in" id="results-card"></div>
  <div class="btn-row" style="margin-top:6px">
    <button class="btn-primary" id="btn-again">Play Again ğŸš€</button>
    <button class="btn-secondary" onclick="showScreen('level-screen')">All Missions ğŸ—ºï¸</button>
    <button class="btn-secondary" onclick="showScreen('char-screen')">Change Explorer ğŸ­</button>
  </div>
</div>

<div class="confetti-box" id="confetti-box"></div>

<footer class="dedication">
  <span class="dedicationText">Selphaware 2026 &copy; Â· Dedicated to Sana, Shayaan, Zuhaib, Mikaeel â™¥</span>
</footer>

<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let characters=[], levels=[], selectedChar=null;
let questions=[], curQ=0, correctCount=0, curStreak=0, bestStreak=0, gameLevel=1;
let timerInterval=null, timeLeft=0;
let roundResults=[]; // {correct, timeTaken, timeAllowed} per question
let qStartTime=0;

// â”€â”€ Screens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active')}

// â”€â”€ Init: load chars & levels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init(){
  const [cr,lr]=await Promise.all([fetch('/api/characters').then(r=>r.json()),fetch('/api/levels').then(r=>r.json())]);
  characters=cr; levels=lr;
  renderCharGrid();
  renderLevelGrid();
}

// â”€â”€ Character select â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCharGrid(){
  const g=document.getElementById('char-grid');
  g.innerHTML='';
  characters.forEach(c=>{
    const d=document.createElement('div');
    d.className='char-btn';
    d.dataset.id=c.id;
    d.innerHTML=`<span class="char-emoji">${c.emoji}</span><span class="char-name">${c.name}</span>`;
    d.onclick=()=>selectChar(c,d);
    g.appendChild(d);
  });
}

function selectChar(c,el){
  document.querySelectorAll('.char-btn').forEach(b=>b.classList.remove('selected'));
  el.classList.add('selected');
  selectedChar=c;
  document.getElementById('btn-char-go').disabled=false;
}

async function confirmCharacter(){
  if(!selectedChar)return;
  await fetch('/api/select-character',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({characterId:selectedChar.id})});
  document.getElementById('lv-avatar').textContent=selectedChar.emoji;
  document.getElementById('lv-greeting').textContent=`${selectedChar.name}'s Missions`;
  showScreen('level-screen');
}

// â”€â”€ Level select â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderLevelGrid(){
  const g=document.getElementById('level-grid');
  g.innerHTML='';
  levels.forEach((lv,i)=>{
    const card=document.createElement('div');
    card.className='level-card';
    let ops=lv.ops.join(' ');
    if(lv.fractions) ops+=' Â½';
    if(lv.brackets) ops+=' ( )';
    card.innerHTML=`
      <div class="lv-num">Level ${lv.id} Â· Ages ${lv.age}</div>
      <div class="lv-name">${lv.name}</div>
      <div class="lv-ops">${ops} Â· Numbers up to ${lv.maxNum}</div>
      <div class="lv-meta">${lv.count} questions Â· ${lv.time}s each</div>
      <div class="lv-mult">Ã—${lv.multiplier} score multiplier</div>
    `;
    card.onclick=()=>startGame(lv.id);
    g.appendChild(card);
  });
}

// â”€â”€ Game â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startGame(level){
  gameLevel=level;
  const res=await fetch(`/api/questions/${level}`);
  const data=await res.json();
  questions=data.questions;
  curQ=0;correctCount=0;curStreak=0;bestStreak=0;roundResults=[];
  const cfg=data.level;
  document.getElementById('hud-char-emoji').textContent=selectedChar?.emoji||'ğŸ‘¾';
  document.getElementById('hud-level-name').textContent=cfg.name;
  document.getElementById('hud-qtotal').textContent=questions.length;
  showScreen('game-screen');
  showQuestion();
}

function showQuestion(){
  if(curQ>=questions.length){endGame();return}
  const q=questions[curQ];
  document.getElementById('hud-qnum').textContent=curQ+1;
  document.getElementById('hud-correct').textContent=correctCount;
  document.getElementById('q-text').innerHTML=q.display;
  document.getElementById('feedback').textContent='';
  const inp=document.getElementById('ans-input');
  inp.value='';inp.className='ans-input';inp.disabled=false;inp.focus();
  document.getElementById('btn-submit').disabled=false;
  updateStreak();
  qStartTime=performance.now();
  startTimer(q.time);
}

function startTimer(secs){
  clearInterval(timerInterval);
  timeLeft=secs;const total=secs;
  document.getElementById('hud-timer').textContent=Math.ceil(timeLeft);
  const bar=document.getElementById('timer-bar');
  bar.style.width='100%';bar.classList.remove('warn');
  timerInterval=setInterval(()=>{
    timeLeft-=0.1;
    if(timeLeft<=0){timeLeft=0;clearInterval(timerInterval);timeUp()}
    bar.style.width=(timeLeft/total*100)+'%';
    if(timeLeft/total<.3)bar.classList.add('warn');
    document.getElementById('hud-timer').textContent=Math.ceil(timeLeft);
  },100);
}

function timeUp(){
  const q=questions[curQ];
  curStreak=0;updateStreak();
  roundResults.push({correct:false,timeTaken:q.time,timeAllowed:q.time});
  const fb=document.getElementById('feedback');
  fb.textContent=`â° Time's up! Answer: ${q.answer}`;fb.className='feedback no';
  const inp=document.getElementById('ans-input');inp.className='ans-input wrong';inp.disabled=true;
  document.getElementById('btn-submit').disabled=true;
  setTimeout(()=>{curQ++;showQuestion()},1800);
}

function submitAnswer(){
  clearInterval(timerInterval);
  const q=questions[curQ];
  const inp=document.getElementById('ans-input');
  const fb=document.getElementById('feedback');
  const raw=inp.value.trim();
  if(!raw){inp.focus();return}

  const elapsed=(performance.now()-qStartTime)/1000;
  const ok=checkAnswer(raw,q.answer);

  if(ok){
    correctCount++;curStreak++;if(curStreak>bestStreak)bestStreak=curStreak;
    inp.className='ans-input correct';fb.className='feedback ok';
    const phrases=['Amazing! âœ¨','Brilliant! ğŸŒŸ','Correct! ğŸš€','Awesome! ğŸ’«','Yes! â˜„ï¸','Perfect! ğŸª','Super! ğŸŒ™','Wow! ğŸ›¸'];
    fb.textContent=phrases[~~(Math.random()*phrases.length)];
  } else {
    curStreak=0;
    inp.className='ans-input wrong';fb.className='feedback no';
    fb.textContent=`Nope â€” it's ${q.answer}`;
  }

  roundResults.push({correct:ok,timeTaken:Math.round(elapsed*10)/10,timeAllowed:q.time});
  updateStreak();
  inp.disabled=true;document.getElementById('btn-submit').disabled=true;
  setTimeout(()=>{curQ++;showQuestion()},ok?900:1800);
}

function checkAnswer(u,c){
  const norm=s=>s.toLowerCase().replace(/\s+/g,'').replace(/â„/g,'/');
  if(norm(u)===norm(c))return true;
  const uN=parseFloat(u),cN=parseFloat(c);
  if(!isNaN(uN)&&!isNaN(cN)&&Math.abs(uN-cN)<.001)return true;
  if(u.includes('/')||c.includes('/')){
    const pf=s=>{const p=s.replace(/\s+/g,' ').trim().split(' ');if(p.length===2&&p[1].includes('/')){const w=parseFloat(p[0]),[n,d]=p[1].split('/').map(Number);if(!isNaN(w)&&!isNaN(n)&&d)return w+n/d}if(s.includes('/')){const[n,d]=s.split('/').map(Number);if(!isNaN(n)&&d)return n/d}return parseFloat(s)};
    const a=pf(u),b=pf(c);if(!isNaN(a)&&!isNaN(b)&&Math.abs(a-b)<.001)return true;
  }
  return false;
}

function updateStreak(){
  const el=document.getElementById('streak-line');
  el.textContent=curStreak>=3?`ğŸ”¥ ${curStreak} in a row!`:'';
}

// â”€â”€ End game â†’ submit to server â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function endGame(){
  clearInterval(timerInterval);
  const res=await fetch('/api/submit',{
    method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({level:gameLevel,results:roundResults})
  });
  const data=await res.json();
  const s=data.score;
  const pct=s.totalQuestions>0?Math.round(s.correctCount/s.totalQuestions*100):0;

  let emoji,title,sub;
  if(pct===100){emoji='ğŸ†';title='PERFECT SCORE!';sub='Absolute superstar!';launchConfetti()}
  else if(pct>=80){emoji='ğŸŒŸ';title='Excellent!';sub='You\'re an amazing explorer!';launchConfetti()}
  else if(pct>=60){emoji='ğŸš€';title='Great Work!';sub='Keep practising to reach the stars!'}
  else if(pct>=40){emoji='ğŸŒ™';title='Good Try!';sub='Every astronaut needs practice!'}
  else{emoji='ğŸ’ª';title='Keep Going!';sub='You\'ve got this â€” try again!'}

  const card=document.getElementById('results-card');
  let html=`
    <div class="res-emoji">${emoji}</div>
    <div class="res-title">${title}</div>
    <div class="res-sub">${sub}</div>
    ${s.perfectBonus?`<div class="perfect-banner">ğŸ‰ Perfect Round Bonus: +${s.perfectBonus} points!</div>`:''}
    <div class="score-hero">${s.totalScore.toLocaleString()}</div>
    <div class="score-label">Total Score</div>
    <div class="res-stats">
      <div class="rs"><div class="v green">${s.correctCount}/${s.totalQuestions}</div><div class="l">Correct</div></div>
      <div class="rs"><div class="v cyan">${s.avgSpeed}s</div><div class="l">Avg Speed</div></div>
      <div class="rs"><div class="v orange">Ã—${s.multiplier}</div><div class="l">Multiplier</div></div>
      <div class="rs"><div class="v pink">${bestStreak}</div><div class="l">Best Streak</div></div>
      <div class="rs"><div class="v gold">${pct}%</div><div class="l">Accuracy</div></div>
      <div class="rs"><div class="v" style="color:var(--ring)">#${data.rank}</div><div class="l">Rank</div></div>
    </div>
    <div class="score-breakdown">
      <h4>Scoring</h4>
      <div class="sb-row"><span>Base points (100 Ã— correct Ã— Ã—${s.multiplier})</span></div>
      <div class="sb-row"><span>Speed bonus (faster = more points)</span></div>
      <div class="sb-row"><span>Streak bonus (+50 per streak level)</span></div>
      ${s.perfectBonus?`<div class="sb-row perfect"><span>Perfect round bonus</span><span>+${s.perfectBonus}</span></div>`:''}
    </div>
  `;

  // Leaderboard
  if(data.topScores&&data.topScores.length>0){
    html+=`<div class="lb-section"><h4>ğŸ† Level ${gameLevel} Leaderboard</h4>`;
    data.topScores.forEach((e,i)=>{
      const isYou=i===data.rank-1;
      const rc=i===0?'top1':i===1?'top2':i===2?'top3':'';
      html+=`<div class="lb-row ${isYou?'lb-you':''}">
        <span class="lb-rank ${rc}">${i+1}</span>
        <span class="lb-emoji">${e.emoji}</span>
        <span class="lb-name">${e.name}</span>
        <span class="lb-score">${e.score.toLocaleString()}</span>
      </div>`;
    });
    html+=`</div>`;
  }

  card.innerHTML=html;
  document.getElementById('btn-again').onclick=()=>startGame(gameLevel);
  showScreen('results-screen');
}

// â”€â”€ Confetti â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function launchConfetti(){
  const box=document.getElementById('confetti-box');box.innerHTML='';
  const cols=['#fbbf24','#ec4899','#3b82f6','#34d399','#f97316','#22d3ee','#c084fc','#ef4444'];
  for(let i=0;i<60;i++){
    const p=document.createElement('div');p.className='confetti-piece';
    p.style.left=Math.random()*100+'%';
    p.style.background=cols[~~(Math.random()*cols.length)];
    p.style.animationDelay=Math.random()*1.5+'s';
    p.style.animationDuration=(2+Math.random()*2)+'s';
    p.style.width=(6+Math.random()*8)+'px';
    p.style.height=(6+Math.random()*8)+'px';
    p.style.borderRadius=Math.random()>.5?'50%':'2px';
    box.appendChild(p);
  }
  setTimeout(()=>box.innerHTML='',4000);
}

// â”€â”€ Keyboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('keydown',e=>{
  if(e.key==='Enter'&&document.getElementById('game-screen').classList.contains('active')){
    const inp=document.getElementById('ans-input');
    if(!inp.disabled&&inp.value.trim())submitAnswer();
  }
});

// â”€â”€ Go! â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
init();
</script>
</body>
</html>
